<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Using FIR filters &mdash; Documentation  documentation</title>
    <link rel="stylesheet" href="_static/xdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/xcomment.js"></script>
    <link rel="top" title="Documentation  documentation" href="index.html" />
    <link rel="next" title="module_asrc" href="asrc.html" />
    <link rel="prev" title="module_cascading_biquad" href="biquad.html" /> 

<script>
function setheight() {
h1 = document.getElementById('d1').style.height;
h2 = document.getElementById('d2').style.height;

if (parseInt(h1) > parseInt(h2)) {
document.getElementById('d2').style.height=h1 + "px";
}
else {
document.getElementById('d1').style.height=h2 + "px";
}

}
</script>
</head>

<body onload="setheight();">

  

    <div class="document" id='d1'>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
<div style="float: right">
<a href="biquad.html"
                        title="previous chapter"> &lt&lt </a>
<a href="asrc.html"
                        title="next chapter"> &gt&gt </a></p>
</div>

            
  <div class="section" id="using-fir-filters">
<h1>Using FIR filters<a class="headerlink" href="#using-fir-filters" title="Permalink to this headline">¶</a></h1>
<p>TO use a FIR filter you need to (1) compute a set of FIR coefficients and
(2) insert these coefficients in the source code and call the FIR function
to perform a FIR.</p>
<div class="section" id="computing-fir-coefficients">
<h2>Computing FIR coefficients<a class="headerlink" href="#computing-fir-coefficients" title="Permalink to this headline">¶</a></h2>
<p>The program to compute the filter coefficients is in build_fir_coefficients
directory. It accepts the following options:</p>
<table border="1" class="docutils">
<colgroup>
<col width="34%" />
<col width="66%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Effect</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>-low freq</td>
<td>Lowpass filter, with given corner freq</td>
</tr>
<tr class="row-odd"><td>-high freq</td>
<td>Highpass filter, with given corner freq</td>
</tr>
<tr class="row-even"><td>-bp freql freqh</td>
<td>Bandpass filter, with given frequencies</td>
</tr>
<tr class="row-odd"><td>-bs freql freqh</td>
<td>Bandstop filter, with given frequencies</td>
</tr>
<tr class="row-even"><td>-gaussian</td>
<td>Gaussian window</td>
</tr>
<tr class="row-odd"><td>-blackman</td>
<td>Blackman window</td>
</tr>
<tr class="row-even"><td>-hamming</td>
<td>Hamming window (default)</td>
</tr>
<tr class="row-odd"><td>-hann</td>
<td>Hann window</td>
</tr>
<tr class="row-even"><td>-n taps</td>
<td>Number of taps - should be odd</td>
</tr>
<tr class="row-odd"><td>-fs freq</td>
<td>Sample frequency, default 48000</td>
</tr>
<tr class="row-even"><td>-xc sourceFileName</td>
<td>name of source file, default coeffs.xc</td>
</tr>
<tr class="row-odd"><td>-csv csvFileName</td>
<td>name of csv file, default response.csv</td>
</tr>
</tbody>
</table>
<p>A single windowing function can be specified, if none is specified a
Hamming window is used. The number of taps must be specified and must be
odd. The corner frequency defaults to 48 KHz.</p>
<p>One or more of -low, -high, -bp, or -bs must be specified. This creates a
single FIR that implements the cascade of filters specified.</p>
<p>The program outputs a source code file that initialises the coefficients
table, and a CSV file that contains the response curves.</p>
<p>The program outputs a percentage error, indicating roughly how much of your
filter got lost because of limitations in the number of taps and the
windowing. If the error is high, you can try and increase the number of
taps. Note that low cut-off frequencies (relative to the sample frequency)
require a high number of taps.</p>
</div>
<div class="section" id="calling-simple-fir">
<h2>Calling simple FIR<a class="headerlink" href="#calling-simple-fir" title="Permalink to this headline">¶</a></h2>
<p>The function that performs the run time fir is in module_fir. Include the
file fir.h and call:</p>
<div class="highlight-none"><div class="highlight"><pre>filteredSample = fir(sampleValue, coefficientTable, stateTable, N)
</pre></div>
</div>
<p>sampleValue should be a 8.24 fixed point number, and the function returns
the filtered 8.24 value. CoefficientTable is the name of the array that
was produced by the code above, stateTable should be an array of N integers
which is initialised to all zeroes prior to the first call to fir, and N is
the number of taps (the -n parameter above). The stateTable will contain
N old samples.</p>
</div>
<div class="section" id="calling-optimised-fir">
<h2>Calling optimised FIR<a class="headerlink" href="#calling-optimised-fir" title="Permalink to this headline">¶</a></h2>
<p>The optimised fir also resides in module_fir. There are 5 ways to call this
function: running the code inside the current thread, or running it in 1,
2, 3, or 4 separate threads (on the same core so to share the coefficients
table).</p>
<div class="section" id="in-1-to-4-extra-threads">
<h3>In 1 to 4 extra threads<a class="headerlink" href="#in-1-to-4-extra-threads" title="Permalink to this headline">¶</a></h3>
<p>Create your coefficient table (N elements), and create four temporary arrays (N/4+12
elements each); N must be a multiple of 48. Now create a process as
follows:</p>
<div class="highlight-none"><div class="highlight"><pre>par {
   ...
   fir_par4_48(coeffs, N, cin, data0, data1, data2, data3);
   ...
}
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">cin</span></tt> should be a streaming channel. Each sample to be filtered should be
output onto this channel as a signed integer. Once a sample has been
output, the filtered value should be input on the channel as a <tt class="docutils literal"><span class="pre">long</span>
<span class="pre">long</span></tt>; which is the 64 bit result.</p>
<p>In order to use three threads, call the function <tt class="docutils literal"><span class="pre">fir_par3_36</span></tt> and pass
one array less; make sure that all arrays have at least N/3+12 elements.</p>
<p>In order to use two threads, call the function <tt class="docutils literal"><span class="pre">fir_par2_24</span></tt> and pass
two temporary arrays only; make sure that they have at least N/2+12 elements.</p>
<p>In order to use one thread, call the function <tt class="docutils literal"><span class="pre">fir_par1_12</span></tt> and pass
one temporary array only which must have N+12 elements.</p>
</div>
<div class="section" id="inside-the-current-thread">
<h3>Inside the current thread<a class="headerlink" href="#inside-the-current-thread" title="Permalink to this headline">¶</a></h3>
<p>Call the function:</p>
<div class="highlight-none"><div class="highlight"><pre>fir12(coefficients, data, w, N);
</pre></div>
</div>
<p>With your coefficients, the data, N elements, and an index w indicating the
index of the most recent sample in the data array. data[w] should be the
most recent sample, data[w+1] should be the previous sample, etc. Note that
data should be N+12 samples long, and that data[0..11] should be replicated
in data[N..N+11]. See the code in fir_par1_12 for an example how to drive
it.</p>
</div>
</div>
</div>



          </div>
        </div>
      </div>
      <div class="sphinxsidebar" id='d2'>
        <div class="sphinxsidebarwrapper">
<h3><a href="index.html">Documentation</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="summary.html">DSP Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="biquad.html">module_cascading_biquad</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Using FIR filters</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#computing-fir-coefficients">Computing FIR coefficients</a></li>
<li class="toctree-l2"><a class="reference internal" href="#calling-simple-fir">Calling simple FIR</a></li>
<li class="toctree-l2"><a class="reference internal" href="#calling-optimised-fir">Calling optimised FIR</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#in-1-to-4-extra-threads">In 1 to 4 extra threads</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inside-the-current-thread">Inside the current thread</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="asrc.html">module_asrc</a></li>
</ul>

<div id="searchbox" style="display: none;margin-bottom: 10px;">
  <h3>Search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>



    <div class="footer">
    </div>
  </body>
</html>



